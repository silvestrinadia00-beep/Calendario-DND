<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Calendario disponibilità D&D</title>
  <style>
    :root{
      --bg:#f8fafc; --fg:#0f172a; --muted:#64748b;
      --card:#ffffff; --accent:#4f46e5; --border:#e5e7eb;
      --blue:#93c5fd; --yellow:#fde68a; --green:#bbf7d0; --red:#ef4444;
      --chip:#e2e8f0;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,Segoe UI,Roboto,sans-serif}
    .container{max-width:980px;margin:0 auto;padding:14px}

    /* Logo + titolo */
    .logo{display:flex;justify-content:center;margin:6px 0 8px}
    .logo img{max-width:260px;width:100%;height:auto;display:block}
    h1{font-size:clamp(20px,3.2vw,26px);margin:6px 0 10px;text-align:center}

    /* Card e controlli */
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:12px}
    input,select,button{font:inherit;padding:8px 10px;border-radius:12px;border:1px solid var(--border);background:#fff}
    button{background:var(--accent);color:#fff;border:none;font-weight:600;cursor:pointer}
    button.ghost{background:#fff;color:var(--fg);border:1px solid var(--border)}
    .namebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .namebar input{min-width:200px;flex:1}
    .muted{color:var(--muted)}

    /* ===== Calendario compatto (7 colonne SEMPRE) ===== */
    .toolbar{display:flex;gap:6px;align-items:center;justify-content:center}
    .weeknames,.grid{display:grid;grid-template-columns:repeat(7,minmax(0,1fr))}
    .weeknames{color:var(--muted);font-weight:700;text-align:center;margin:4px 0 6px}
    .grid{gap:4px}

    .cell{
      background:#fff;border:1px solid var(--border);border-radius:10px;
      aspect-ratio:1/1; /* quadrato perfetto anche su mobile */
      padding:6px; display:flex; flex-direction:column; gap:2px; position:relative;
      transition:box-shadow .15s,border-color .15s, background-color .15s; cursor:pointer;
    }
    .cell:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .cell.ghost{visibility:hidden;border:none;background:transparent;box-shadow:none;pointer-events:none}

    .top{display:flex;align-items:center;justify-content:space-between}
    .daynum{font-weight:800;font-size:12px}
    .badge{font-size:10px;background:#fff;border:1px solid var(--border);border-radius:999px;padding:1px 5px}
    .dot{position:absolute;left:50%;bottom:6px;transform:translateX(-50%);width:5px;height:5px;border-radius:50%}

    /* Stati colore */
    .any{border-color:var(--blue);box-shadow:0 0 0 2px rgba(147,197,253,.35) inset}
    .any .dot{background:#60a5fa}
    .almost6{background:var(--yellow)}
    .full7{background:var(--green)}

    /* ===== Lista sotto ===== */
    .dayitem{border:1px solid var(--border);border-radius:12px;padding:10px;margin:8px 0;background:#fff}
    .dayhead{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
    .chip{background:var(--chip);padding:4px 8px;border-radius:999px;font-size:13px}
    .chip button{margin-left:6px;background:transparent;border:none;color:#ef4444;font-weight:700;cursor:pointer}

    /* Popup */
    .popup{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
    .box{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;width:92%;max-width:420px}
    .list{margin:6px 0;max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#f9fafb;padding:8px}
    .list .row{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:6px;border-bottom:1px solid var(--border)}
    .list .row:last-child{border-bottom:none}
    .timebar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btns{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
    .danger{background:#ef4444;color:#fff}
    .err{color:#b91c1c;margin-top:6px;display:none}
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGO -->
    <div class="logo">
      <img src="./Dungeons-and-Dragons-logo.png" alt="Dungeons & Dragons Logo" onerror="this.parentElement.style.display='none'">
    </div>

    <h1>Calendario disponibilità D&D</h1>

    <!-- Nome -->
    <div class="card">
      <div class="namebar">
        <label for="nome"><b>Nome</b></label>
        <input id="nome" placeholder="Scrivi il tuo nome">
        <button id="saveNameBtn">Salva</button>
        <span id="okName" class="muted" style="display:none">Nome salvato ✔︎</span>
      </div>
    </div>

    <!-- Calendario -->
    <div class="card">
      <div class="toolbar">
        <button id="prevYear"  class="ghost">«</button>
        <button id="prevMonth" class="ghost">‹</button>
        <select id="monthSel"></select>
        <select id="yearSel"></select>
        <button id="nextMonth" class="ghost">›</button>
        <button id="nextYear"  class="ghost">»</button>
      </div>

      <div class="weeknames">
        <div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div><div>Dom</div>
      </div>
      <div class="grid" id="grid"></div>
    </div>

    <!-- Lista giorni con disponibilità -->
    <div class="card">
      <h3 style="margin:0 0 6px 0">Disponibilità del mese</h3>
      <div id="daysList" class="muted">Nessuna disponibilità registrata.</div>
    </div>
  </div>

  <!-- Popup -->
  <div class="popup" id="popup">
    <div class="box">
      <h3 id="popupTitle" style="margin:0 0 8px 0">Dettagli giorno</h3>
      <div class="list" id="namesList"></div>
      <div class="timebar">
        <label>Dalle <input id="from" type="time" value="20:30"></label>
        <label>Alle <input id="to" type="time" value="23:30"></label>
      </div>
      <div class="btns">
        <button id="confirmBtn">Conferma</button>
        <button id="removeBtn"  class="danger">Cancella il mio</button>
        <button id="closeBtn"   class="ghost">Chiudi</button>
      </div>
      <div id="popupError" class="err"></div>
      <div id="needName" class="muted" style="margin-top:6px;display:none">Per confermare/cancellare il tuo, salva prima il nome.</div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, deleteField,
      collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCLe8BSPpF3j5MSoi_6lsXL6RFT8vUVFWk",
      authDomain: "calendario-dnd.firebaseapp.com",
      projectId: "calendario-dnd",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Refs
    const nomeInput = document.getElementById("nome");
    const saveNameBtn = document.getElementById("saveNameBtn");
    const okName = document.getElementById("okName");
    const grid = document.getElementById("grid");
    const daysList = document.getElementById("daysList");
    const monthSel = document.getElementById("monthSel");
    const yearSel  = document.getElementById("yearSel");
    const prevMonthBtn = document.getElementById("prevMonth");
    const nextMonthBtn = document.getElementById("nextMonth");
    const prevYearBtn  = document.getElementById("prevYear");
    const nextYearBtn  = document.getElementById("nextYear");

    const popup = document.getElementById("popup");
    const popupTitle = document.getElementById("popupTitle");
    const namesList = document.getElementById("namesList");
    const fromInp = document.getElementById("from");
    const toInp   = document.getElementById("to");
    const confirmBtn = document.getElementById("confirmBtn");
    const removeBtn  = document.getElementById("removeBtn");
    const closeBtn   = document.getElementById("closeBtn");
    const popupError = document.getElementById("popupError");
    const needName   = document.getElementById("needName");

    // Stato
    const room = "dnd";
    let savedName = localStorage.getItem('dnd_name') || "";
    if (savedName) {
      nomeInput.value = savedName; nomeInput.disabled = true; saveNameBtn.disabled = true; okName.style.display = "inline";
    }
    let authed = false;
    let currentY = new Date().getFullYear();
    let currentM = new Date().getMonth()+1; // 1..12
    let monthData = new Map(); // YYYY-MM-DD -> { availability:{} }
    let currentYMD = null;
    let daysListDelegationReady = false;

    // Helpers
    const pad2 = n => String(n).padStart(2,"0");
    const ymd  = (y,m,d) => `${y}-${pad2(m)}-${pad2(d)}`;
    const dim  = (y,m) => new Date(y, m, 0).getDate();
    const firstDowMon0 = (y,m) => (new Date(y, m-1, 1).getDay() + 6) % 7;
    const IT_MONTHS = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    function slugifyName(name){
      const s = (name||"").normalize("NFKD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
      return s || "utente";
    }
    const safeDisplay = (v,k)=> (v && v.display && v.display.trim()) ? v.display.trim() : k;

    // Selectors (anni fino a 2099)
    function fillSelectors(){
      monthSel.innerHTML = IT_MONTHS.map((n,i)=>`<option value="${i+1}">${n}</option>`).join('');
      const ys=[]; for(let y=1970;y<=2099;y++) ys.push(`<option value="${y}">${y}</option>`);
      yearSel.innerHTML = ys.join('');
      monthSel.value = String(currentM); yearSel.value = String(currentY);
    }
    fillSelectors();

    // Auth anonima
    onAuthStateChanged(auth, (user)=>{ authed = !!user; });
    signInAnonymously(auth).catch(()=>{});

    // Salva nome
    saveNameBtn.addEventListener("click", ()=>{
      const n = nomeInput.value.trim();
      if (n.length < 2) return alert("Il nome deve avere almeno 2 caratteri.");
      if (n.length > 40) return alert("Nome troppo lungo.");
      savedName = n;
      localStorage.setItem('dnd_name', savedName);
      nomeInput.disabled = true; saveNameBtn.disabled = true; okName.style.display = "inline";
    });

    // Navigazione
    function navMonth(delta){
      let m = Number(monthSel.value), y = Number(yearSel.value);
      m += delta; if(m<1){m=12;y--;} if(m>12){m=1;y++;}
      monthSel.value = m; yearSel.value = y; onMonthChange();
    }
    prevMonthBtn.onclick = ()=> navMonth(-1);
    nextMonthBtn.onclick = ()=> navMonth(+1);
    prevYearBtn.onclick  = ()=> { yearSel.value = Number(yearSel.value)-1; onMonthChange(); };
    nextYearBtn.onclick  = ()=> { yearSel.value = Number(yearSel.value)+1; onMonthChange(); };
    monthSel.onchange = yearSel.onchange = onMonthChange;

    function onMonthChange(){
      currentM = Number(monthSel.value); currentY = Number(yearSel.value); loadMonth();
    }

    // Build grid con ghost
    function buildGrid(){
      grid.innerHTML = "";
      const offset = firstDowMon0(currentY,currentM);
      for (let i=0;i<offset;i++){
        const ghost = document.createElement("div");
        ghost.className = "cell ghost";
        ghost.innerHTML = `<div class="top"><span class="daynum"></span><span class="badge"></span></div><div class="dot"></div>`;
        grid.appendChild(ghost);
      }
      const days = dim(currentY,currentM);
      for(let d=1; d<=days; d++){
        const key = ymd(currentY,currentM,d);
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.dataset.key = key;
        cell.innerHTML = `
          <div class="top">
            <span class="daynum">${d}</span>
            <span class="badge"></span>
          </div>
          <div class="dot"></div>
        `;
        cell.addEventListener("click", ()=> openDay(key));
        grid.appendChild(cell);
      }
    }

    // Render celle + lista
    function renderCellsAndList(){
      const days = dim(currentY,currentM);
      const items = [];
      for(let d=1; d<=days; d++){
        const key = ymd(currentY,currentM,d);
        const cell = grid.querySelector(`.cell[data-key="${key}"]`);
        const data = monthData.get(key) || { availability:{} };
        const avail = data.availability || {};
        const names = Object.keys(avail).sort((a,b)=>safeDisplay(avail[a],a).localeCompare(safeDisplay(avail[b],b),'it'));
        const cnt = names.length;

        if (cell){
          const badge = cell.querySelector('.badge');
          const dot = cell.querySelector('.dot');
          cell.classList.remove('any','almost6','full7');
          badge.textContent = cnt ? cnt : '';
          if (cnt >= 7) cell.classList.add('full7');
          else if (cnt === 6) cell.classList.add('almost6');
          if (cnt > 0) cell.classList.add('any'); // bordo blu
          if (dot) dot.style.background = (cnt>=7)?'#22c55e' : (cnt===6)?'#ca8a04' : (cnt>0)?'#60a5fa' : 'transparent';
        }

        if (cnt>0){
          const dateObj = new Date(currentY, currentM-1, d);
          const dd = String(d).padStart(2,'0');
          const ww = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'][dateObj.getDay()];
          const head = `${dd}/${pad2(currentM)} – ${ww}`;
          const chips = names.map(k=>{
            const t = avail[k]||{};
            const shown = safeDisplay(t,k);
            const ff = t.from||'nd', tt = t.to||'nd';
            return `<span class="chip" data-key="${k}" data-day="${key}">
                      ${shown} (${ff}–${tt})
                      <button title="Elimina">×</button>
                    </span>`;
          }).join('');
          items.push(`<div class="dayitem"><div class="dayhead"><div><b>${head}</b></div><div class="muted">${cnt} persone</div></div><div class="chips">${chips}</div></div>`);
        }
      }
      daysList.innerHTML = items.length ? items.join('') : 'Nessuna disponibilità registrata.';

      // Delegation per la X della lista (una sola volta)
      if(!daysListDelegationReady){
        daysList.addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('.chip button');
          if(!btn) return;
          ev.stopPropagation();
          const chip = btn.closest('.chip');
          const day  = chip.dataset.day;
          const key  = chip.dataset.key;
          if(!confirm('Eliminare questa disponibilità?')) return;
          await removeAvailability(day, key
